!function(e){"function"==typeof define&&define.amd?define("orders",e):e()}(function(){"use strict";var s={template:"#orders-single",props:{orderId:Number},data(){return{order:null,loading:!0,pending:!1,pricing:null,booking:null,additions:null,fields:null,actions:null,notes:null,state:{showFields:!0,showPricing:!1,showRules:!1,showTags:!0}}},created(){this.getOrder(()=>this.loading=!1)},methods:{getOrder(t){this.loading=!0;var e=Voxel_Config.ajax_url+"&action=orders.view";jQuery.get(e,{order_id:this.orderId},e=>{e.success&&(this.order=e.data,this.pricing=this.order.pricing,this.booking=this.order.booking,this.additions=this.order.additions,this.fields=this.order.fields,this.actions=this.order.actions,this.notes=this.order.notes),t(e)})},backToAll(){"history-back"===this.$root.config.backButton?history.back():(this.$root.activeOrder=null,Voxel.deleteSearchParam("order_id"),this.$root.orders.length||this.$root.getOrders())},doAction(e){this.pending=!0,jQuery.get(Voxel_Config.ajax_url,{action:"orders."+e,order_id:this.orderId}).always(e=>{e.success?e.redirect_to?window.location.replace(e.redirect_to):this.getOrder(()=>this.pending=!1):(this.pending=!1,Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})},applyTag(e){this.pending=!0,jQuery.get(Voxel_Config.ajax_url,{action:"orders.apply_tag",order_id:this.orderId,tag:e}).always(e=>{e.success?this.getOrder(()=>this.pending=!1):(this.pending=!1,Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})},getQrLink(e){var t=new URL(Voxel_Config.ajax_url);return t.searchParams.set("action","orders.get_tag_qr_code"),t.searchParams.set("order_id",this.orderId),t.searchParams.set("tag",e.key),t.toString()}},computed:{qrTags(){return this.order.tags.can_edit&&"completed"===this.order.status.slug?this.order.tags.list.filter(e=>e.has_qr_code):[]}}},i={template:"#orders-create-note",props:{order:Object},data(){return{message:"",files:{label:this.$root.config.l10n.attachImages,id:"files",key:"files",value:null,props:{allowedTypes:this.order.order.comments.allowed_file_types,maxCount:this.order.order.comments.max_count}}}},methods:{postComment(){var e=new FormData,t={message:this.message},t=(this.$refs.commentFiles.onSubmit(t,e),e.append("fields",JSON.stringify(t)),jQuery.param({action:"orders.post_comment",order_id:this.order.orderId}));jQuery.post({url:Voxel_Config.ajax_url+"&"+t,data:e,contentType:!1,processData:!1,success:e=>{e.success?(this.order.notes.push(e.comment),this.message="",this.files.value=[],this.$refs.commentFiles.files=[],this.$refs.commentForm.blur()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}})},cancelComment(){this.$refs.commentForm.blur()}}},r={template:"#orders-deliver-files",props:{order:Object},data(){return{message:"",files:{label:this.$root.config.l10n.attachFiles,id:"deliverables",key:"deliverables",value:null,props:{allowedTypes:this.order.order.deliverables.allowed_file_types,maxCount:this.order.order.deliverables.max_count}}}},methods:{submit(){var e=new FormData,t={message:this.message},t=(this.$refs.files.onSubmit(t,e),e.append("fields",JSON.stringify(t)),jQuery.param({action:"orders.deliver_files",order_id:this.order.orderId}));jQuery.post({url:Voxel_Config.ajax_url+"&"+t,data:e,contentType:!1,processData:!1,success:e=>{e.success?(this.order.notes.push(e.comment),this.message="",this.files.value=[],this.$refs.files.files=[],this.$refs.deliverFrom.blur(),Voxel.alert(this.$root.config.l10n.filesDelivered,"success")):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}})},cancel(){this.$refs.deliverFrom.blur()}}},a={template:"#create-post-media-popup",props:{multiple:{type:Boolean,default:!0},ignore:{type:Array,default:[]},customTarget:[Object,String],saveLabel:String},emits:["save","blur","open"],data(){return{page:1,files:[],selected:{},active:!1,loading:!0,hasMore:!1,firstLoad:!0}},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},selectFile(e){this.selected[e.id]?delete this.selected[e.id]:(this.multiple||(this.selected={}),this.selected[e.id]=e)},loadMedia(){var e=Voxel_Config.ajax_url+"&action=list_media&page="+this.page;jQuery.get(e,e=>{this.loading=!1,e.files&&(this.files=this.files.concat(e.files)),this.hasMore=!!e.has_more})},loadMore(){this.loading=!0,this.page++,this.loadMedia()},openLibrary(){this.$emit("open"),this.firstLoad&&this.loadMedia(),this.firstLoad=!1,this.active=!this.active},isImage(e){return e.type.startsWith("image/")},save(){this.active=!1,this.$emit("save",this.selected),this.selected={}},clear(){this.selected={}}}},o={template:"#create-post-file-field",props:{field:Object,mediaTarget:[Object,String],index:{type:Number,default:null},sortable:{type:Boolean,default:!0},showLibrary:{type:Boolean,default:!0},previewImages:{type:Boolean,default:!0}},data(){return{accepts:"",dragActive:!1}},created(){null===this.field.value&&(this.field.value=[]),this.accepts=Object.values(this.field.props.allowedTypes).join(", ")},mounted(){this.updatePreviews(),jQuery(this.$refs.input).on("change",e=>{for(var t=0;t<e.target.files.length;t++){var s=e.target.files[t];this.pushFile(s)}this.$refs.input.value="",this.updatePreviews(),this.$emit("files-added")}),jQuery(()=>{var e=jQuery(this.$refs.fileList);this.sortable&&(e.sortable({items:"> .ts-file",helper:"clone",appendTo:this.$el,containment:"parent",tolerance:"intersect",revert:150}),e.on("sortupdate",()=>{var s=[];e.find(".ts-file").each((e,t)=>{s.push(this.field.value[t.dataset.index])}),this.field.value=s,this.updatePreviews()})),e.find(".pick-file-input").on("click",e=>{e.preventDefault(),this.$refs.input.click()})})},unmounted(){setTimeout(()=>{Object.values(this.field.value).forEach(e=>{"new_upload"===e.source&&URL.revokeObjectURL(e.preview)})},10),this.sortable&&jQuery(this.$refs.fileList).sortable("destroy")},methods:{getStyle(e){return e.type.startsWith("image/")&&this.previewImages?`background-image: url('${e.preview}');`:""},updatePreviews(){var e=jQuery(this.$refs.fileList),i=[];this.field.value.forEach((e,t)=>{var s=e.type.startsWith("image/")&&this.previewImages,s=jQuery(`
					<div class="ts-file ${s?"ts-file-img":""}" style="${this.getStyle(e)}" data-index="${t}">
						<div class="ts-file-info">
							<svg fill="#000000" width="52" height="52" version="1.1" id="lni_lni-cloud-upload" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 64 64" style="enable-background:new 0 0 64 64;" xml:space="preserve">
								<g>
									<path d="M34.3,27.3c-0.5-0.5-1.1-0.8-1.8-0.8c-0.7,0-1.3,0.3-1.8,0.8l-4.9,5.1c-0.7,0.7-0.7,1.8,0,2.5c0.7,0.7,1.8,0.7,2.5,0
										l2.5-2.6v9.5c0,1,0.8,1.8,1.8,1.8c1,0,1.8-0.8,1.8-1.8v-9.5l2.5,2.6c0.3,0.4,0.8,0.5,1.3,0.5c0.4,0,0.9-0.2,1.2-0.5
										c0.7-0.7,0.7-1.8,0-2.5L34.3,27.3z"/>
									<path d="M57.8,23.7c-2.7-2.9-6.6-4.9-10.6-5.6c-2.2-3.5-5.5-6.1-9.3-7.4c-1.7-0.6-3.7-1-5.8-1c-9.6,0-17.5,7.5-17.9,16.9
										C6.9,27.2,1.3,33.2,1.3,40.4c0,7.6,6.3,13.8,14.1,13.9c0,0,0,0,0,0h28.8c10.3,0,18.6-8.2,18.6-18.2C62.8,31.5,61,27.1,57.8,23.7z
										 M44.1,50.8H15.4c-6,0-10.6-4.6-10.6-10.4S9.4,30,15.4,30h0.5c1,0,1.8-0.8,1.8-1.8v-1.1c0-7.7,6.5-14,14.4-14
										c1.7,0,3.2,0.3,4.6,0.8c3.3,1.1,6.1,3.5,7.9,6.6c0.3,0.5,0.8,0.8,1.3,0.9c3.6,0.4,7,2,9.3,4.6c2.6,2.8,4,6.3,4,10
										C59.3,44.2,52.5,50.8,44.1,50.8z"/>
								</g>
						</svg><code></code>
						</div>
						<a href="#" class="ts-remove-file flexify"><svg fill="#000000" width="52" height="52" version="1.1" id="lni_lni-close" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
							 y="0px" viewBox="0 0 64 64" style="enable-background:new 0 0 64 64;" xml:space="preserve">
						<path d="M34.5,32L62.2,4.2c0.7-0.7,0.7-1.8,0-2.5c-0.7-0.7-1.8-0.7-2.5,0L32,29.5L4.2,1.8c-0.7-0.7-1.8-0.7-2.5,0
							c-0.7,0.7-0.7,1.8,0,2.5L29.5,32L1.8,59.8c-0.7,0.7-0.7,1.8,0,2.5c0.3,0.3,0.8,0.5,1.2,0.5s0.9-0.2,1.2-0.5L32,34.5l27.7,27.8
							c0.3,0.3,0.8,0.5,1.2,0.5c0.4,0,0.9-0.2,1.2-0.5c0.7-0.7,0.7-1.8,0-2.5L34.5,32z"/>
						</svg></a>
					</div>
				`);s.find("code").text(e.name),s.find("a").on("click",e=>{e.preventDefault(),this.field.value.splice(t,1),this.updatePreviews()}),i.push(s)}),e.find(".pick-file-input").siblings().remove(),e.append(i)},pushFile(e){1===this.field.props.maxCount&&(this.field.value=[]),this.field.value.push({source:"new_upload",name:e.name,type:e.type,preview:URL.createObjectURL(e),item:e})},onDrop(e){this.dragActive=!1,e.dataTransfer.items?[...e.dataTransfer.items].forEach(e=>{"file"===e.kind&&this.pushFile(e.getAsFile())}):[...e.dataTransfer.files].forEach(e=>{this.pushFile(e)}),this.updatePreviews(),this.$emit("files-added")},onMediaPopupSave(e){1===this.field.props.maxCount&&(this.field.value=[]);var t={};this.field.value.forEach(e=>{"existing"===e.source&&(t[e.id]=!0)}),Object.values(e).forEach(e=>{t[e.id]||this.field.value.push(e)}),this.updatePreviews(),this.$emit("files-added")},onSubmit(t,s,e=null){var i;i=null!==e?`files[${this.field.id}::row-${e}][]`:`files[${this.field.id}][]`,t[this.field.key]=[],this.field.value.forEach(e=>{"new_upload"===e.source?(s.append(i,e.item),t[this.field.key].push("uploaded_file")):"existing"===e.source&&t[this.field.key].push(e.id)})},async cacheToLocalStorage(r){r[this.field.key]=[];let e=[];return this.field.value.forEach(i=>{if("existing"===i.source)r[this.field.key].push(i);else if("new_upload"===i.source){let t={source:"local_storage",name:i.item.name,type:i.item.type,lastModified:i.item.lastModified,dataUrl:null},s=new FileReader;e.push(new Promise(e=>{s.onload=()=>{t.dataUrl=s.result,r[this.field.key].push(t),e()},s.readAsDataURL(i.item)}))}}),Promise.all(e)},async applyFromLocalStorage(t){if(Array.isArray(t)&&t.length){let e=[];return t.forEach(s=>{e.push(new Promise(t=>{fetch(s.dataUrl).then(e=>e.blob()).then(e=>{this.pushFile(new File([e],s.name,{type:s.type,lastModified:new Date})),t()})}))}),Promise.all(e).then(()=>this.$root.$nextTick(this.updatePreviews())),Promise.all(e)}}}};window.render_orders=()=>{Array.from(document.querySelectorAll(".ts-orders")).forEach(e=>{var t;e.__vue_app__||((t=Vue.createApp({el:e,mixins:[Voxel.mixins.base],data(){return{orders:[],type:"all",page:1,status:"all",search:"",loading:!0,hasMore:!1,activeOrder:null,activePopup:null,config:{}}},created(){this.config=JSON.parse(this.$options.el.dataset.config),this.config.activeOrder?this.activeOrder=this.config.activeOrder:this.getOrders()},methods:{getOrders(){this.loading=!0;var e=Voxel_Config.ajax_url+"&action=orders.get";jQuery.get(e,{page:this.page,type:this.type,status:this.status,search:this.search},e=>{e.success&&(this.orders=e.data,this.hasMore=e.has_more),this.loading=!1})},setStatus(e){this.status=e,this.page=1,this.getOrders(),this.$refs.status?.blur()},setType(e){this.type=e,this.page=1,this.getOrders(),this.$refs.type?.blur()},viewOrder(e){this.activeOrder=e,Voxel.setSearchParam("order_id",e)},searchOrders(){this.page=1,this.getOrders()}}})).component("form-popup",Voxel.components.popup),t.component("form-group",Voxel.components.formGroup),t.component("single-order",s),t.component("create-note",i),t.component("deliver-files",r),t.component("booking-details",{template:"#orders-booking-details",props:{order:Object,booking:Object}}),t.component("display-actions",{template:"#orders-display-actions",props:{order:Object,orderDetails:Object}}),t.component("display-note",{template:"#orders-display-note",props:{order:Object,note:Object}}),t.component("subscription-status",{template:"#orders-subscription-status",props:{order:Object,subscription:Object}}),o.template="#orders-file-field",t.component("media-popup",a),t.component("field-file",o),t.mount(e))})},window.render_orders(),jQuery(document).on("voxel:markup-update",window.render_orders)});
