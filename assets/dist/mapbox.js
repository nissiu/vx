!function(t){"function"==typeof define&&define.amd?define("mapbox",t):t()}(function(){"use strict";Voxel.Maps.Autocomplete=function(t,o){this.init(t,o)},Voxel.Maps.Bounds=function(t,o){this.southwest=t,this.northeast=o,this.init(t,o)},Voxel.Maps.Bounds.prototype.extend=function(t){},Voxel.Maps.Bounds.prototype.empty=function(){},Voxel.Maps.Bounds.prototype.getSourceObject=function(){},Voxel.Maps.Bounds.prototype.getSouthWest=function(){return this.southwest},Voxel.Maps.Bounds.prototype.getNorthEast=function(){return this.northeast},Voxel.Maps.Geocoder=function(){this.init()},Voxel.Maps.getGeocoder=function(){return Voxel.Maps._geocoder||(Voxel.Maps._geocoder=new Voxel.Maps.Geocoder),Voxel.Maps._geocoder},Voxel.Maps.Geocoder.prototype.geocode=function(t,o,e){},Voxel.Maps.Geocoder.prototype.formatFeature=function(t){},Voxel.Maps.Geocoder.prototype.getUserLocation=function({fetchAddress:o=!0,receivedPosition:e=t=>{},receivedAddress:n=t=>{},positionFail:t=()=>{},addressFail:s=()=>{}}={}){if(!navigator.geolocation)return t();navigator.geolocation.getCurrentPosition(t=>{t=new Voxel.Maps.LatLng(t.coords.latitude,t.coords.longitude);e(t),!1!==o&&Voxel.Maps.getGeocoder().geocode(t.toGeocoderFormat(),t=>t?n(t):(Voxel.alert(Voxel_Config.l10n.positionFail,"error"),s()))},()=>t())},Voxel.Maps.LatLng=function(t,o){this.init(t,o)},Voxel.Maps.LatLng.prototype.getLatitude=function(){},Voxel.Maps.LatLng.prototype.getLongitude=function(){},Voxel.Maps.LatLng.prototype.getSourceObject=function(){},Voxel.Maps.LatLng.prototype.toGeocoderFormat=function(){},Voxel.Maps.Map=function({el:t,zoom:o=10,center:e=new Voxel.Maps.LatLng(42,20),minZoom:n=4,maxZoom:s=16,draggable:i=!0}){this.init({el:t,zoom:o,center:e,minZoom:n,maxZoom:s,draggable:i})},Voxel.Maps.Map.prototype.setZoom=function(t){},Voxel.Maps.Map.prototype.getZoom=function(){},Voxel.Maps.Map.prototype.getMinZoom=function(){},Voxel.Maps.Map.prototype.getMaxZoom=function(){},Voxel.Maps.Map.prototype.setCenter=function(t){},Voxel.Maps.Map.prototype.getCenter=function(){},Voxel.Maps.Map.prototype.fitBounds=function(t){},Voxel.Maps.Map.prototype.panTo=function(t){},Voxel.Maps.Map.prototype.getClickPosition=function(t){},Voxel.Maps.Map.prototype.addListener=function(t,o){},Voxel.Maps.Map.prototype.addListenerOnce=function(t,o){},Voxel.Maps.Map.prototype.removeListener=function(t){},Voxel.Maps.Map.prototype.trigger=function(t){},Voxel.Maps.Map.prototype.mapEvent=function(t){return void 0!==this.eventMap[t]?this.eventMap[t]:t},Voxel.Maps.Map.prototype.removeMarkers=function(){for(var t=0;t<this.markers.length;t++)this.markers[t].remove();this.markers=[]},Voxel.Maps.Map.prototype.getSourceObject=function(){},Voxel.Maps.Marker=function({map:t=null,position:o=null,onClick:e=null,template:n=null}){this.template=n,this.init({map:t,position:o,onClick:e})},Voxel.Maps.Marker.prototype.getPosition=function(){},Voxel.Maps.Marker.prototype.setPosition=function(t){},Voxel.Maps.Marker.prototype.getMap=function(){},Voxel.Maps.Marker.prototype.setMap=function(t){},Voxel.Maps.Marker.prototype.remove=function(){},Voxel.Maps.Marker.prototype.addClass=function(){},Voxel.Maps.Marker.prototype.removeClass=function(){},Voxel.Maps.Marker.prototype.getTemplate=function(){var t=this.template||'<div class="map-marker marker-type-icon"><i class="las la-map-marker"></i></div>';return jQuery(`<div class="marker-wrapper">${t}</div>`)},Voxel.Maps.Popup=function({map:t=null,position:o=null,content:e=null}){this.init({map:t,position:o,content:e})},Voxel.Maps.Popup.prototype.init=function(t){},Voxel.Maps.Popup.prototype.setContent=function(t){},Voxel.Maps.Popup.prototype.setPosition=function(t){},Voxel.Maps.Popup.prototype.setMap=function(t){},Voxel.Maps.Popup.prototype.show=function(){},Voxel.Maps.Popup.prototype.hide=function(){},Voxel.Maps.Circle=function({map:t=null,center:o=null,radius:e=null,visible:n=null,className:s="map-circle"}){this.init({map:t,center:o,radius:e,visible:n,className:s})},Voxel.Maps.Autocomplete.prototype.init=function(t,o){!t instanceof Element||(this.el=t,this.onChange=o,this.input=jQuery(this.el),this.focusedItem=0,this.hasQueried=!1,this.attachDropdown(),this.input.on("input",Voxel.helpers.debounce(this.querySuggestions.bind(this),300)),this.input.on("focusin",this.showDropdown.bind(this)),this.input.on("focusout",this.hideDropdown.bind(this)),this.input.on("keydown click",this.navigateDropdown.bind(this)),this.dropdown.on("click",".suggestion",t=>this.selectItem(jQuery(t.currentTarget).index())))},Voxel.Maps.Autocomplete.prototype.querySuggestions=function(t){this.resetFocus(),this.showDropdown(),this.onChange(),Voxel.Maps.getGeocoder().geocode(t.target.value,{limit:5},function(t){if(this.hasQueried=!0,this.removeSuggestions(),!t)return!1;t.forEach(this.addSuggestion.bind(this))}.bind(this))},Voxel.Maps.Autocomplete.prototype.navigateDropdown=function(t){this.hasQueried||this.input.trigger("input"),this.showDropdown(),40===t.keyCode&&(this.focusedItem++,this.focusItem()),38===t.keyCode&&(this.focusedItem--,this.focusItem()),13===t.keyCode&&(t.preventDefault(),0!==this.focusedItem)&&this.selectItem(this.focusedItem-1)},Voxel.Maps.Autocomplete.prototype.focusItem=function(){this.dropdown.find(".suggestions-list .suggestion").removeClass("active");var t=this.dropdown.find(".suggestions-list .suggestion");this.focusedItem<0&&(this.focusedItem=t.length),this.focusedItem>t.length&&(this.focusedItem=0),0!==this.focusedItem&&this.dropdown.find(".suggestions-list .suggestion").eq(this.focusedItem-1).addClass("active")},Voxel.Maps.Autocomplete.prototype.resetFocus=function(t){this.focusedItem=0,this.dropdown.find(".suggestions-list .suggestion").removeClass("active")},Voxel.Maps.Autocomplete.prototype.showDropdown=function(t){this.dropdown.addClass("active");var o=this.input.get(0).getBoundingClientRect(),e=this.input.offset();this.dropdown.css({top:e.top+o.height+"px",left:e.left+"px",width:o.width+"px"})},Voxel.Maps.Autocomplete.prototype.hideDropdown=function(t){this.dropdown.removeClass("active")},Voxel.Maps.Autocomplete.prototype.selectItem=function(t){t=this.dropdown.find(".suggestions-list .suggestion").eq(t).data("place");this.input.val(t.address),this.resetFocus(),this.hideDropdown(),this.onChange(t)},Voxel.Maps.Autocomplete.prototype.attachDropdown=function(){this.dropdown=jQuery('<div class="ts-autocomplete-dropdown"><div class="suggestions-list"></div></div>'),this.input.addClass("ts-autocomplete-input").attr("autocomplete","off"),jQuery("body").append(this.dropdown)},Voxel.Maps.Autocomplete.prototype.removeSuggestions=function(){this.dropdown.find(".suggestions-list").html("")},Voxel.Maps.Autocomplete.prototype.addSuggestion=function(t){var o=jQuery(['<div class="suggestion">','<span class="suggestion--address"></span>',"</div>"].join(""));o.data("place",t),o.find(".suggestion--address").text(t.address),this.dropdown.find(".suggestions-list").append(o)},Voxel.Maps.Bounds.prototype.init=function(t,o){this.southwest=t,this.northeast=o,this.bounds=new mapboxgl.LngLatBounds(t?.getSourceObject(),o?.getSourceObject())},Voxel.Maps.Bounds.prototype.getSouthWest=function(){return this.southwest},Voxel.Maps.Bounds.prototype.getNorthEast=function(){return this.northeast},Voxel.Maps.Bounds.prototype.extend=function(t){this.bounds.extend(t.getSourceObject())},Voxel.Maps.Bounds.prototype.empty=function(){return this.bounds.isEmpty()},Voxel.Maps.Bounds.prototype.getSourceObject=function(){return this.bounds},Voxel.Maps.Geocoder.prototype.init=function(){},Voxel.Maps.Geocoder.prototype.geocode=function(t,e,o){var n=this,s=!1,i=("function"==typeof e&&(o=e,e={}),{access_token:Voxel_Config.mapbox?.api_key,limit:1,types:["country","region","postcode","district","place","locality","neighborhood"]}),e=jQuery.extend(!0,{},i,e);if(!encodeURIComponent(t).length)return o(s);jQuery.get({url:"https://api.mapbox.com/geocoding/v5/mapbox.places/{query}.json".replace("{query}",encodeURIComponent(t)),data:e,dataType:"json",success:function(t,o){"success"===o&&t&&t.features.length&&(s=1===e.limit?n.formatFeature(t.features[0]):t.features.map(n.formatFeature))},complete:function(){o(s)}})},Voxel.Maps.Geocoder.prototype.formatFeature=function(t){var o;return o=t.bbox?new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(t.bbox[1],t.bbox[0]),new Voxel.Maps.LatLng(t.bbox[3],t.bbox[2])):new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(t.geometry.coordinates[1],t.geometry.coordinates[0]),new Voxel.Maps.LatLng(t.geometry.coordinates[1],t.geometry.coordinates[0])),{address:t.place_name,latlng:new Voxel.Maps.LatLng(t.geometry.coordinates[1],t.geometry.coordinates[0]),viewport:o}},Voxel.Maps.LatLng.prototype.init=function(t,o){this.latlng=new mapboxgl.LngLat(o,t)},Voxel.Maps.LatLng.prototype.getLatitude=function(){return this.latlng.lat},Voxel.Maps.LatLng.prototype.getLongitude=function(){return this.latlng.lng},Voxel.Maps.LatLng.prototype.toGeocoderFormat=function(){return[this.getLongitude(),this.getLatitude()].join(",")},Voxel.Maps.LatLng.prototype.getSourceObject=function(){return this.latlng},Voxel.Maps.Map.prototype.init=function({el:t,zoom:o,center:e,minZoom:n,maxZoom:s}){this.eventMap={zoom_changed:"zoomstart",bounds_changed:"moveend"},this.map=new mapboxgl.Map({container:t,zoom:o,minZoom:2.3<=n?n:2.3,maxZoom:s<=24?s:24,interactive:!0,style:Voxel_Config.mapbox?.skin||"mapbox://styles/mapbox/streets-v12",scrollZoom:!0,projection:"mercator",dragRotate:!1}),this.map.addControl(new mapboxgl.NavigationControl({showCompass:!1})),this.map.addControl(new mapboxgl.FullscreenControl),this.setCenter(e)},Voxel.Maps.Map.prototype.setZoom=function(t){this.map.setZoom(t)},Voxel.Maps.Map.prototype.getZoom=function(){return this.map.getZoom()},Voxel.Maps.Map.prototype.getMinZoom=function(){return this.map.getMinZoom()},Voxel.Maps.Map.prototype.getMaxZoom=function(){return this.map.getMaxZoom()},Voxel.Maps.Map.prototype.setCenter=function(t){this.map.setCenter(t.getSourceObject())},Voxel.Maps.Map.prototype.getCenter=function(){return new Voxel.Maps.LatLng(this.map.getCenter().lat,this.map.getCenter().lng)},Voxel.Maps.Map.prototype.getBounds=function(){var t=this.map.getBounds(),o=t.getNorthEast(),t=t.getSouthWest();return new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(t.lat,t.lng),new Voxel.Maps.LatLng(o.lat,o.lng))},Voxel.Maps.Map.prototype.fitBounds=function(t){t.getSourceObject().isEmpty()||this.map.fitBounds(t.getSourceObject(),{padding:15,animate:!1})},Voxel.Maps.Map.prototype.panTo=function(t){this.map.panTo(t.getSourceObject())},Voxel.Maps.Map.prototype.getClickPosition=function(t){return new Voxel.Maps.LatLng(t.lngLat.lat,t.lngLat.lng)},Voxel.Maps.Map.prototype.addListener=function(t,o){return this.map.on(this.mapEvent(t),function(t){o(t)}),{event:t,cb:o}},Voxel.Maps.Map.prototype.addListenerOnce=function(t,o){return this.map.once(this.mapEvent(t),function(t){o(t)}),{event:t,cb:o}},Voxel.Maps.Map.prototype.removeListener=function(t){this.map.off(t.event,t.cb)},Voxel.Maps.Map.prototype.trigger=function(t){this.map.fire(this.mapEvent(t))},Voxel.Maps.Map.prototype.getSourceObject=function(){return this.map},Voxel.Maps.Marker.prototype.init=function({map:t,position:o,onClick:e}){this.node=this.getTemplate().get(0),this.marker=new mapboxgl.Marker(this.node),this.node.addEventListener("click",t=>{e&&e(t,this)}),o&&this.setPosition(o),t&&this.setMap(t)},Voxel.Maps.Marker.prototype.getPosition=function(){return this.position},Voxel.Maps.Marker.prototype.setPosition=function(t){this.position=t,this.marker.setLngLat(t.getSourceObject())},Voxel.Maps.Marker.prototype.getMap=function(){return this.map},Voxel.Maps.Marker.prototype.setMap=function(t){this.map=t,this.marker.addTo(t.getSourceObject())},Voxel.Maps.Marker.prototype.remove=function(){return this.marker.remove(),this},Voxel.Maps.Marker.prototype.addClass=function(t){return this.node?.classList.add(t)},Voxel.Maps.Marker.prototype.removeClass=function(t){return this.node?.classList.remove(t)},Voxel.Maps.Marker.prototype.getSourceObject=function(){return this.marker},Voxel.Maps.Popup.prototype.init=function({map:t,position:o,content:e}){this.popup=new mapboxgl.Popup({closeButton:!1,maxWidth:"none",className:"ts-mapbox-popup ts-marker",anchor:"bottom",offset:0}),this.map=t,o&&this.setPosition(o),e&&this.setContent(e),t&&this.setMap(t)},Voxel.Maps.Popup.prototype.setContent=function(t){this.popup.setDOMContent(t),setTimeout(()=>this.fitToScreen(),0)},Voxel.Maps.Popup.prototype.setPosition=function(t){this.popup.setLngLat(t.getSourceObject())},Voxel.Maps.Popup.prototype.setMap=function(t){this.map=t},Voxel.Maps.Popup.prototype.remove=function(){this.popup.remove()},Voxel.Maps.Popup.prototype.show=function(){this.popup.addTo(this.map.getSourceObject())},Voxel.Maps.Popup.prototype.hide=function(){this.popup.remove()},Voxel.Maps.Popup.prototype.fitToScreen=function(){var t=this.popup.getElement().getBoundingClientRect();let o=t.height+10,e=t.width/2+10,n=30,s=t.width/2+10;var t=this.map.getSourceObject(),i=t.getCanvas().getBoundingClientRect(),p=t.project(t.getCenter());let a=p.x,r=p.y;var u=t.project(this.popup.getLngLat());i.width-u.x<e&&(p.x+=e-(i.width-u.x)),u.x<s&&(p.x-=s-u.x),u.y<o-1&&(p.y-=o-u.y),i.height-u.y<n-1&&(p.y+=n-(i.height-u.y)),p.x===a&&p.y===r||t.panTo(t.unproject(p),{duration:200})},Voxel.Maps.Circle.prototype.init=function({map:t=null,center:o=null,radius:e=null}){this.map=t,this.locationNode=jQuery('<div class="hidden"><div class="map-circle-center"></div></div>').get(0),this.locationMarker=new mapboxgl.Marker(this.locationNode),this.locationMarker.setLngLat(o.getSourceObject()),this.locationMarker.addTo(t.getSourceObject()),this.node=jQuery('<div class="hidden"><div class="map-circle"></div></div>').get(0),this.marker=new mapboxgl.Marker(this.node),this.marker.setLngLat(o.getSourceObject()),this.radius=e,this.marker.addTo(t.getSourceObject()),this._draw(),t.addListener("zoom",()=>this._draw()),t.addListener("pitch",()=>this._draw())},Voxel.Maps.Circle.prototype.hide=function(){this.node.classList.add("hidden"),this.locationNode.classList.add("hidden")},Voxel.Maps.Circle.prototype.show=function(){this.node.classList.remove("hidden"),this.locationNode.classList.remove("hidden")},Voxel.Maps.Circle.prototype.setCenter=function(t){this.marker.setLngLat(t.getSourceObject()),this.locationMarker.setLngLat(t.getSourceObject()),this._draw()},Voxel.Maps.Circle.prototype.setRadius=function(t){this.radius=t,this._draw()},Voxel.Maps.Circle.prototype.getBounds=function(){return new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(this.bounds.getSouth(),this.bounds.getWest()),new Voxel.Maps.LatLng(this.bounds.getNorth(),this.bounds.getEast()))},Voxel.Maps.Circle.prototype._updateBounds=function(){var t=this.marker.getLngLat(),o={north:null,east:null,south:null,west:null},e=(o.east=o.west=this.radius/t.distanceTo(new mapboxgl.LngLat(t.lng+1,t.lat)),o.north=this.radius/t.distanceTo(new mapboxgl.LngLat(t.lng,t.lat+1)),o.south=this.radius/t.distanceTo(new mapboxgl.LngLat(t.lng,t.lat-1)),(t,o,e)=>Math.max(o,Math.min(t,e)));this.bounds=new mapboxgl.LngLatBounds([e(t.lng-o.west,-180,180),e(t.lat-o.south,-90,90)],[e(t.lng+o.east,-180,180),e(t.lat+o.north,-90,90)])},Voxel.Maps.Circle.prototype._draw=function(){this._updateBounds();var t=this.map.getSourceObject(),o=t.project(this.bounds.getSouthWest()),t=t.project(this.bounds.getNorthEast()),e=this.node.querySelector(".map-circle");e.style.left=o.x+"px",e.style.top=t.y+"px",e.style.width=t.x-o.x+"px",e.style.height=o.y-t.y+"px"},jQuery(t=>{mapboxgl.accessToken=Voxel_Config.mapbox?.api_key,Voxel.Maps.Loaded=!0,document.dispatchEvent(new Event("maps:loaded")),jQuery(".ts-map.ts-map-autoload").each((t,o)=>{var e=jQuery(o).data("config"),o={el:o,zoom:3};e&&(e.zoom&&(o.zoom=e.zoom),e.minZoom&&(o.minZoom=e.minZoom),e.maxZoom&&(o.maxZoom=e.maxZoom),e.center)&&(o.center=new Voxel.Maps.LatLng(e.center.lat,e.center.lng));let n=new Voxel.Maps.Map(o);e.markers&&e.markers.forEach(t=>{new Voxel.Maps.Marker({map:n,position:new Voxel.Maps.LatLng(t.lat,t.lng),template:t.template})})})})});
